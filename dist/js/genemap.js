var GENEMAP=GENEMAP||{};GENEMAP.AnnotationXMLReader=function(){var t=function(t,e){var n=t.getElementsByTagName(e);return n&&n.length>0?n[0].childNodes[0].nodeValue:null},e=function(e){var n=+e.getElementsByTagName("start")[0].childNodes[0].nodeValue,o=+e.getElementsByTagName("end")[0].childNodes[0].nodeValue,a=(o-n)/2+n;return{id:e.getAttribute("id"),chromosome:e.getElementsByTagName("chromosome")[0].childNodes[0].nodeValue,start:n,end:o,midpoint:a,type:t(e,"type"),color:t(e,"color"),label:t(e,"label"),link:t(e,"link"),score:t(e,"score"),pvalue:t(e,"pvalue"),trait:t(e,"trait"),selected:!1}},n=function(t){var n={};n.features=[];for(var o=t.getElementsByTagName("feature"),a=0;a<o.length;a++)n.features.push(e(o[a]));return n};return{readAnnotationXML:function(t){return log.info("reading annotation file: ",t),d3.promise.xml(t).then(n)}}};var GENEMAP=GENEMAP||{};GENEMAP.AutoLayoutDecorator=function(t){if(!(this instanceof arguments.callee))return new arguments.callee(t);var e={width:900,height:600,numberPerRow:7,margin:{top:.1,left:.1,bottom:.1,right:.1},cellMargin:{top:.05,left:.05,bottom:.1,right:.05},labelHeight:.02,chromosomeAspectRatio:.04,scale:1,annotations:{label:{size:3,show:!0,showThreshold:8,maxSize:14},marker:{size:6,show:!0,maxSize:20}}},n=_.merge({},e,t),o=function(t,e){var o=_.cloneDeep(t);if(t.show){var a=t.size*n.scale;e.showThreshold&&(o.show=a>=e.showThreshold),e.maxSize&&a>e.maxSize&&(o.size=e.maxSize/n.scale)}return o};return{decorateGenome:function(t){var e=t,a={width:n.width*(1-n.margin.left-n.margin.right),height:n.height*(1-n.margin.top-n.margin.bottom)},i=Math.min(n.numberPerRow,e.chromosomes.length),r=Math.ceil(e.chromosomes.length/i);log.trace("numberPerRow= "+n.numberPerRow+", chromosomes.length= "+e.chromosomes.length),log.trace("Cols= "+i+", rows= "+r);var l={width:a.width/i,height:a.height/r},s={top:l.height*n.cellMargin.top,bottom:l.height*n.cellMargin.bottom,left:l.width*n.cellMargin.left,right:l.width*n.cellMargin.right},c=n.labelHeight*l.height,u=n.labelHeight*l.height,d=l.height-c-u-s.top-s.bottom,h=Math.min(65/n.scale,d*n.chromosomeAspectRatio),p=l.width-h-s.left-s.right,f=p/2,m=Math.max.apply(null,e.chromosomes.map(function(t){return t.length})),g={label:_.pick(n.annotations.label,["size","show"]),marker:_.pick(n.annotations.marker,["size","show"])};g.label=o(g.label,n.annotations.label),g.marker=o(g.marker,n.annotations.marker);var v={chromosomePosition:{height:d,width:h,x:s.left+f,y:s.top+c},labelPosition:{height:c,width:l.width-s.left-s.right,chromosomeWidth:h,x:s.left,y:s.top},sizeLabelPosition:{cellHeight:d,height:u,width:l.width-s.left-s.right,x:s.left,y:s.top+c},qtlAnnotationPosition:{height:d,width:f,chromosomeWidth:h,x:s.left,y:s.top+c},geneAnnotationPosition:{height:d,width:f,x:s.left+f+h,y:s.top+c},longestChromosome:m,annotations:g,scale:n.scale};return 1==e.chromosomes.length&&(v.chromosomePosition.x=s.left+.5*f,v.geneAnnotationPosition.x=s.left+.5*f+h,v.qtlAnnotationPosition.width=.5*f,v.geneAnnotationPosition.width=1.5*f,v.labelPosition.x=s.left+.5*f,v.labelPosition.width=h,v.sizeLabelPosition.x=s.left+.5*f,v.sizeLabelPosition.width=h),e.drawing=_.pick(n,["width","height"]),e.drawing.margin={top:n.margin.top*e.drawing.height,left:n.margin.left*e.drawing.width,bottom:n.margin.bottom*e.drawing.height,right:n.margin.right*e.drawing.width},e.chromosomes.forEach(function(t,e){var o=e%n.numberPerRow,a=Math.floor(e/n.numberPerRow);t.cell={y:a*l.height+n.margin.top*n.height,x:o*l.width+n.margin.left*n.width,width:l.width,height:l.height}}),e.cellLayout=v,e},width:function(t){return arguments.length?(n.width=t,this):n.width},height:function(t){return arguments.length?(n.height=t,this):n.height},numberPerRow:function(t){return arguments.length?(n.numberPerRow=t,this):n.numberPerRow},margin:function(t){return arguments.length?(n.margin=_.merge(n.margin,t),this):n.margin},labelHeight:function(t){return arguments.length?(n.labelHeight=t,this):n.labelHeight},cellMargin:function(t){return arguments.length?(n.cellMargin=t,this):n.cellMargin},chromosomeAspectRatio:function(t){return arguments.length?(n.chromosomeAspectRatio=t,this):n.chromosomeAspectRatio},scale:function(t){return arguments.length?(n.scale=t,this):n.scale}}};var GENEMAP=GENEMAP||{};GENEMAP.BasemapXmlReader=function(){var t=function(t){return{index:t.getAttribute("index"),start:t.getElementsByTagName("start")[0].childNodes[0].nodeValue,end:t.getElementsByTagName("end")[0].childNodes[0].nodeValue,color:t.getElementsByTagName("color")[0].childNodes[0].nodeValue}},e=function(e){for(var n={index:e.getAttribute("index"),length:e.getAttribute("length"),number:e.getAttribute("number"),bands:[]},o=e.getElementsByTagName("band"),a=0;a<o.length;a++){var i=t(o[a]);n.bands.push(i)}return n},n=function(t){var n={};n.chromosomes=[];for(var o=t.getElementsByTagName("chromosome"),a=0;a<o.length;a++){var i=e(o[a]);n.chromosomes.push(i)}return n};return{readBasemapXML:function(t){return log.info("reading basemap file: ",t),d3.promise.xml(t).then(n)}}},!function(t){var e=function(e,n){this.options=n,this.$body=t(document.body),this.$navbar=t(".navbar.navbar-fixed-top"),this.$element=t(e).delegate('[data-dismiss="modal-popup"]',"click.dismiss.modal-popup",t.proxy(this.hide,this)),this.$dialog=this.$element.find(".modal-dialog"),this.options.remote&&this.$element.find(".popover-content").load(this.options.remote),this.$parent=n.$parent};e.prototype=t.extend({},t.fn.modal.Constructor.prototype,{constructor:e,getDimensions:function(t){var e,n;if("offsetWidth"in t[0]&&t[0].offsetWidth)log.trace("Using offsetWidth"),e=t[0].offsetWidth,n=t[0].offsetHeight;else if("getBBox"in t[0]){log.trace("Using getBBox");var o=t[0].getBBox(),a=t[0].getScreenCTM();e=o.width*a.a,n=o.height*a.d}var i={width:e,height:n};return i},show:function(){for(var e=0;e<2;e++){var n=this.$element;n.css({top:0,left:0,display:"block","z-index":1050});var o,a=n[0].offsetWidth,i=n[0].offsetHeight,r=this.$parent,l={my:"left top",at:"left top",of:r,collision:"none",using:function(t,e){o=t}};n.position(l);var s=this.getDimensions(t(r));o=_.merge({},o,s);var c="function"==typeof this.options.placement?this.options.placement.call(this,$tip[0],this.$element[0]):this.options.placement,u=null,d=null;if(this.options.boundingSize){var h={my:"left center",at:"right center",of:this.options.boundingSize[0],collision:"none",using:function(t,e){u=t}};n.position(h);var p={my:"right center",at:"left center",of:this.options.boundingSize[0],collision:"none",using:function(t,e){d=t}};n.position(p)}var f,m=10;switch(c){case"bottom":f={top:o.top+o.height,left:o.left+o.width/2-a/2};break;case"top":f={top:o.top-i,left:o.left+o.width/2-a/2};break;case"left":var g=o.left-a;d&&(g=Math.max(g,d.left)-m),f={top:o.top+o.height/2-i/2,left:g};break;case"right":var g=o.left+o.width;u&&(g=Math.min(g,u.left)+m),f={top:o.top+o.height/2-i/2,left:g}}n.css(f).addClass(c).addClass("in"),n.toggleClass("force-redraw"),t.fn.modal.Constructor.prototype.show.call(this,arguments)}},backdrop:function(e){var n=this,o=this.$element.hasClass("fade")?"fade":"";if(this.isShown&&this.options.backdrop){var a=t.support.transition&&o;this.$backdrop=t('<div class="modal-backdrop '+o+'" style="background:none" />').appendTo(document.body),"static"!=this.options.backdrop&&this.$backdrop.click(t.proxy(this.hide,this)),a&&this.$backdrop[0].offsetWidth,this.$backdrop.addClass("in"),a?this.$backdrop.one(t.support.transition.end,e):e(),n.bodyIsOverflowing&&this.$navbar.css({paddingRight:n.scrollbarWidth})}else!this.isShown&&this.$backdrop?(this.$backdrop.removeClass("in"),t.support.transition&&this.$element.hasClass("fade")?this.$backdrop.one(t.support.transition.end,t.proxy(this.removeBackdrop,this)):this.removeBackdrop(),this.$body.removeClass("modal-open"),this.$navbar.css({paddingRight:0}),this.$body.css({paddingRight:0})):e&&e()}}),t.fn.modalPopover=function(n){return this.each(function(){var o=t(this),a="string"==typeof n?o.data("modal-popover"):void 0,i=t.extend({},t.fn.modalPopover.defaults,o.data(),"object"==typeof n&&n);i.$parent=i.$parent||a&&a.$parent||t(i.target),a||o.data("modal-popover",a=new e(this,i)),"string"==typeof n&&a[n]()})},t.fn.modalPopover.Constructor=e,t.fn.modalPopover.defaults=t.extend({},t.fn.modal.defaults,{placement:"right",modalPosition:"body",keyboard:!0,backdrop:!0}),t(function(){t("body").on("click.modal-popover.data-api",'[data-toggle="modal-popover"]',function(e){var n=t(this),o=n.attr("href"),a=t(n.attr("data-target")||o&&o.replace(/.*(?=#[^\s]+$)/,"")),i=a.data("modal-popover")?"toggle":t.extend({remote:!/#/.test(o)&&o},a.data(),n.data());i.$parent=n,e.preventDefault(),a.modalPopover(i).modalPopover("show").one("hide",function(){n.focus()})})})}(window.jQuery);var GENEMAP=GENEMAP||{};GENEMAP.Chromosome=function(t){function e(t){t.each(function(t){var e=d3.select(this).selectAll(".chromosome").data([t]),n=e.enter().append("g").attr("class","chromosome");n.append("defs"),n.append("rect").classed("background",!0),n.append("g").classed("bands_container",!0),n.append("rect").classed("outline",!0),o.border&&n.append("rect").classed("border",!0),e.each(i),e.exit().remove()})}var n={border:!1,longestChromosome:100,bands:"basemap",layout:{width:10,height:100,x:0,y:0},scale:1,onAnnotationSelectFunction:$.noop(),drawing:null},o=_.merge({},n,t),a=function(){return d3.scale.linear().range([0,o.layout.height]).domain([0,o.longestChromosome])},i=function(t){var e=a(),n=e(t.length),i=d3.select(this);i.attr({id:"chromosome_"+t.number,transform:"translate("+o.layout.x+","+o.layout.y+")"}),i.select("defs").html("").append("mask").attr({id:"chromosome_mask_"+t.number}).append("rect").attr({"class":"mask_rect"}),i.select("#chromosome_mask_"+t.number).attr({width:o.layout.width,height:n});var l={width:o.layout.width,height:n,rx:Math.min(.25*o.layout.width,.01*o.layout.height),ry:Math.min(.25*o.layout.width,.01*o.layout.height)};i.select(".mask_rect").attr(l),i.select("rect.background").attr(l),i.select("rect.outline").attr(l);var c=[],u=function(){var t=i.selectAll("rect.selection").data(c);t.enter().append("rect").attr("class","selection").style({fill:"gray",opacity:.2}),t.attr({x:0,y:function(t){return Math.min(t.start,t.end)},width:o.layout.width,height:function(t){return Math.abs(t.end-t.start)}}),t.exit().remove()},d=d3.behavior.drag().on("dragstart",function(t){var e=d3.mouse(this);c.push({start:e[1],end:e[1]}),u(),d3.event.sourceEvent.stopPropagation()}).on("drag",function(t){c[0].end=d3.event.y,u(),d3.event.sourceEvent.stopPropagation(),d3.event.sourceEvent.preventDefault()}).on("dragend",function(n){d3.event.sourceEvent.stopPropagation();var a=e.invert(c[0].start),i=e.invert(c[0].end);if(a>i){var r=a;a=i,i=r}var l=t.layout.geneBandNodes.filter(function(t){return t.data.midpoint>a&&t.data.midpoint<i});l.forEach(function(t){"gene"==t.data.type?t.data.visible=!0:"geneslist"==t.data.type&&t.data.genesList.forEach(function(t){t.visible=!0})}),o.onAnnotationSelectFunction(),c=[],u()});i.select("rect.background").call(d),o.border&&i.select("rect.border").attr({width:o.layout.width,height:o.layout.height});var h,p=i.select(".bands_container");"basemap"==o.bands?h=r:"genes"==o.bands&&(h=s),h(p,t),i.select(".bands_container").style({mask:"url(#chromosome_mask_"+t.number+")"})},r=function(t,e){var n=a(),i=t.selectAll("rect.band").data(e.bands);i.enter().append("rect").attr("class","band"),i.attr({width:o.layout.width,y:function(t){return n(t.start)},height:function(t){return n(t.end-t.start)},fill:function(t){return t.color}}),i.exit().remove()},l=function(t,e){var n,a=e.end-e.start,i=t(a);return i*o.scale>2?n={y:t(e.start),height:i}:(height=Math.min(2/o.scale,2),n={y:t(e.midpoint)-height/2,height:height}),n.fill=e.color,n.width=o.layout.width,n["fill-opacity"]=.8,n["stroke-dasharray"]=[0,o.layout.width,n.height,o.layout.width+n.height],n["stroke-width"]=o.layout.width/5,n},s=function(t,e){var n=a(),i=t.selectAll("rect.band").data(e.layout.geneBandNodes);i.enter().append("rect").attr({id:function(t){return t.data.id},"class":"band geneline infobox"}),i.each(function(t){attribs=l(n,t),d3.select(this).attr(attribs)}),i.classed("selected",function(t){return t.data.selected}),i.on("click",function(t){"gene"==t.data.type&&(log.info("gene annotation click"),!t.data.displayed||t.data.visible||t.data.hidden?t.data.visible=!t.data.visible:(t.data.visible=!1,t.data.hidden=!0),o.onAnnotationSelectFunction()),"geneslist"==t.data.type&&(log.info("geneslist annotation click"),clusterCurrentlyHidden=t.data.genesList.some(function(t){return!t.displayed}),t.data.genesList.forEach(function(t){t.visible=clusterCurrentlyHidden,t.hidden=!clusterCurrentlyHidden}),o.onAnnotationSelectFunction())}),i.exit().remove()};return e.onAnnotationSelectFunction=function(t){return arguments.length?(o.onAnnotationSelectFunction=t,e):o.onAnnotationSelectFunction},e.layout=function(t){return arguments.length?(o.layout=t,e):o.layout},e.drawing=function(t){return arguments.length?(o.drawing=t,e):o.drawing},e.longestChromosome=function(t){return arguments.length?(o.longestChromosome=t,e):o.longestChromosome},e.bands=function(t){return arguments.length?(o.bands=t,e):o.bands},e.scale=function(t){return arguments.length?(o.scale=t,e):o.scale},e.infoBoxManager=function(t){return arguments.length?(o.infoBoxManager=t,e):o.infoBoxManager},e};var GENEMAP=GENEMAP||{};GENEMAP.ChromosomeCell=function(t){function e(t){t.each(function(t){var e=t.cellLayout,n=d3.select(this).selectAll(".chromosome-cell").data(t.chromosomes),a=n.enter().append("g").attr("class","chromosome-cell");o.border&&a.append("rect").classed("border",!0),n.attr({transform:function(t){return"translate("+t.cell.x+","+t.cell.y+")"}}),o.border&&n.select("rect").attr({x:0,y:0,width:function(t){return t.cell.width},height:function(t){return t.cell.height}});var i=(t.chromosomes.length,GENEMAP.GeneAnnotations().onAnnotationSelectFunction(o.onAnnotationSelectFunction).onExpandClusterFunction(o.onExpandClusterFunction).layout(e.geneAnnotationPosition).longestChromosome(e.longestChromosome).chromosomeWidth(e.chromosomePosition.width).annotationLabelSize(e.annotations.label.size).annotationMarkerSize(e.annotations.marker.size).drawing(o.svg).scale(e.scale));n.call(i);var r=GENEMAP.Chromosome().layout(e.chromosomePosition).longestChromosome(e.longestChromosome).onAnnotationSelectFunction(o.onAnnotationSelectFunction).scale(e.scale).bands("genes").drawing(o.svg);n.call(r);var l=GENEMAP.ChromosomeLabel().layout(e.labelPosition).sizeLayout(e.sizeLabelPosition).onLabelSelectFunction(o.onLabelSelectFunction).longestChromosome(e.longestChromosome).scale(e.scale);n.call(l);var s=GENEMAP.QtlAnnotations().onAnnotationSelectFunction(o.onAnnotationSelectFunction).layout(e.qtlAnnotationPosition).longestChromosome(e.longestChromosome).chromosomeWidth(e.chromosomePosition.width).annotationLabelSize(e.annotations.label.size).annotationMarkerSize(e.annotations.marker.size).showAnnotationLabels(e.annotations.label.show).maxSnpPValue(o.maxSnpPValue).drawing(o.svg).scale(e.scale);n.call(s),n.exit().remove()})}var n={border:!1,onAnnotationSelectFunction:$.noop(),onExpandClusterFunction:$.noop(),onLabelSelectFunction:$.noop(),maxAnnotationLayers:3,maxSnpPValue:1,svg:null},o=_.merge({},n,t);return e.onAnnotationSelectFunction=function(t){return arguments.length?(o.onAnnotationSelectFunction=t,e):o.onAnnotationSelectFunction},e.onExpandClusterFunction=function(t){return arguments.length?(o.onExpandClusterFunction=t,e):o.onExpandClusterFunction},e.onLabelSelectFunction=function(t){return arguments.length?(o.onLabelSelectFunction=t,e):o.onLabelSelectFunction},e.infoBoxManager=function(t){return arguments.length?(o.infoBoxManager=t,e):o.infoBoxManager},e.maxAnnotationLayers=function(t){return arguments.length?(o.maxAnnotationLayers=t,e):o.maxAnnotationLayers},e.maxSnpPValue=function(t){return arguments.length?(o.maxSnpPValue=t,e):o.maxSnpPValue},e.svg=function(t){return arguments.length?(o.svg=t,e):o.svg},e};var GENEMAP=GENEMAP||{};GENEMAP.ChromosomeLabel=function(t){function e(t){t.each(function(t){var e=d3.select(this).selectAll(".chromosome-label").data([t]),n=e.enter().append("g").attr("class","chromosome-label");n.append("text"),o.border&&n.append("rect").classed("border",!0),e.attr({transform:"translate("+o.layout.x+","+o.layout.y+")"}),e.select("text").attr({x:.5*o.layout.width,y:.5*o.layout.height}).style({"font-size":Math.max(14/o.scale,1.2*o.layout.chromosomeWidth)+"px"}).text(t.number).on("click",o.onLabelSelectFunction),o.border&&e.select("rect").attr({width:o.layout.width,height:o.layout.height}),e.exit().remove();var i=d3.select(this).selectAll(".chromosome-size-label").data([t]),n=i.enter().append("g").attr("class","chromosome-size-label");n.append("text");var r=o.sizeLayout.y+o.sizeLayout.cellHeight*t.length/o.longestChromosome,l=1.2*o.labelSize/Math.min(5,o.scale)+"px";i.attr({transform:"translate("+o.sizeLayout.x+","+r+")"}),i.select("text").attr({x:.5*o.sizeLayout.width,y:0,dy:"1em"}).style({"font-size":l}).text(a(t.length)),i.exit().remove()})}var n={border:!1,layout:{width:100,height:20,x:0,y:0},sizeLayout:{width:100,height:20,x:0,y:0},scale:1,onLabelSelectFunction:function(t){alert("Click"+t.number)},labelSize:10,longestChromosome:100},o=_.merge({},n,t),a=function(t){return t<1e3?t:t<1e6?(t/1e3).toFixed(1)+"Kb":(t/1e6).toFixed(1)+"Mb"};return e.longestChromosome=function(t){return arguments.length?(o.longestChromosome=t,e):o.longestChromosome},e.layout=function(t){return arguments.length?(o.layout=t,e):o.layout},e.sizeLayout=function(t){return arguments.length?(o.sizeLayout=t,e):o.sizeLayout},e.scale=function(t){return arguments.length?(o.scale=t,e):o.scale},e.onLabelSelectFunction=function(t){return arguments.length?(o.onLabelSelectFunction=t,e):o.onLabelSelectFunction},e};var GENEMAP=GENEMAP||{};GENEMAP.GeneAnnotationLayout=function(t){var e={longestChromosome:100,layout:{width:10,height:100,x:0,y:0},autoLabels:!0,manualLabels:!0,annotationMarkerSize:5,annotationLabelSize:5,doCluster:!0,nClusters:6,nGenesToDisplay:1e3,maxAnnotationLayers:3,displayedFontSize:13,scale:1},n=_.merge({},e,t),o=function(){return d3.scale.linear().range([0,n.layout.height]).domain([0,n.longestChromosome])},a=function(t,e,n,o){var a=4,i=e/3,r=i/n*a,l=r*t>o;if(l)return 2;var s=e*(.1+.1/t);return i=e-s,r=i/n*a,l=r*t>o,l?1:0},i=function(t,e,o,a,i){var r=3.5;return par={},par.scale=t,par.availableHeight=i,par.lineSpacing=1,par.layerGap=e*(.1+.1/t),par.spaceForLabel=e-par.layerGap,par.setFontSize=Math.min(par.spaceForLabel/o*r,a/n.scale),par.nodeSpacing=par.setFontSize,par.nLabels=.4*i/(par.nodeSpacing+par.lineSpacing),par.density=1,par},r=function(t,e,o,a,i){var r=3.5,l={};return l.scale=t,l.availableHeight=i,l.lineSpacing=1,l.setFontSize=Math.min(e/3/o*r,a/n.scale),l.nodeSpacing=l.setFontSize,l.spaceForLabel=1.3*o*l.setFontSize/r,l.layerGap=Math.min(5*l.setFontSize,e/3),l.density=.9,l.nLabels=.6*i/(l.nodeSpacing+l.lineSpacing),l},l=function(t,e,n,o){o.forEach(function(t){t.displayed=!0,t.fontSize=n.setFontSize});var a=o.map(function(t){return new labella.Node(e(t.midpoint),n.setFontSize,t)});try{t.nodes(a).compute()}catch(i){if(i instanceof RangeError)return null;throw i}return a},s=function(t){allGenes=t.annotations.allGenes.filter(function(t){return t.globalIndex<n.nGenesToDisplay});var e,s=n.layout.width,c=n.layout.height*Math.min(1,.2+t.length/n.longestChromosome),u=allGenes.reduce(function(t,e){return Math.max(t,e.label.length)},0),d=1.1*n.displayedFontSize,h=.9*n.displayedFontSize,p=a(n.scale,s,u,d);2==p?e=r(n.scale,s,u,h,c):1==p?e=i(n.scale,s,u,h,c):0==p&&(e=i(n.scale,s,u,h,c),e.nLabels=0);var f=o();forceConfig={nodeSpacing:e.nodeSpacing,lineSpacing:e.lineSpacing,algorithm:"overlap",minPos:0,maxPos:e.availableHeight,density:e.density};var m=new labella.Force(forceConfig);allGenes.forEach(function(t){t.displayed=!1});var g=n.manualLabels?new Set(allGenes.filter(function(t){return t.visible})):new Set;n.autoLabels&&allGenes.slice(0,e.nLabels).filter(function(t){return!t.hidden}).forEach(function(t){g.add(t)});var v=Array.from(g),y=l(m,f,e,v);y||(m.options({algorithm:"simple"}),y=l(m,f,e,v));var b;if(y){var x=y.map(function(t){return t.getLayerIndex()});b=Math.max.apply(null,x)}if(!y||b>3){log.trace("Too many lables to display - clustering instead");var w=GENEMAP.GeneClusterer().nClusters(Math.max(e.nLabels,1));try{var P=w.createClustersFromGenes(v)}catch(E){log.info(v),P=[]}y=l(m,f,e,P)}renderConfig={direction:"right",layerGap:e.layerGap,nodeHeight:e.spaceForLabel};var C=new labella.Renderer(renderConfig);return C.layout(y),y.forEach(function(t){t.data.path=C.generatePath(t)}),y},c=function(t){var e=GENEMAP.GeneClusterer(),n=t.annotations.genes,o=e.createClustersFromGenes(n);return o};return my={},my.layoutChromosome=function(t){t.layout.annotationNodes=s(t)||t.layout.annotationNodes},my.computeChromosomeClusters=function(t){t.layout.annotationClusters=c(t),t.layout.annotationDisplayClusters=t.layout.annotationClusters.slice()},my.expandAllChromosomeClusters=function(t){t.layout.annotationDisplayClusters=t.annotations.genes},my.collapseAllChromosomeClusters=function(t){t.layout.annotationDisplayClusters=t.layout.annotationClusters.slice()},my.expandAChromosomeCluster=function(t,e){t.layout.annotationDisplayClusters=t.layout.annotationClusters.slice(),e.genesList.forEach(function(e){t.layout.annotationDisplayClusters.push(e)});var n=t.layout.annotationDisplayClusters.indexOf(e);t.layout.annotationDisplayClusters.splice(n,1)},my.computeNormalisedGeneScores=function(t){var e=t.reduce(function(t,e){return t.concat(e.annotations.genes.filter(function(t){return t.displayed}))},[]),n=e.every(function(t){return t.score});if(n){var o=e.reduce(function(t,e){return Math.max(t,e.score)},0),a=e.reduce(function(t,e){return Math.min(t,e.score)},0);e.forEach(function(t){t.normedScore=.5*(t.score-a)/(o-a)+.5})}else e.forEach(function(t){t.normedScore=null})},my};var GENEMAP=GENEMAP||{};GENEMAP.GeneAnnotationPopup=function(t){var e={onAnnotationSelectFunction:$.noop(),drawing:null,popoverId:""},n=_.merge({},e,t),o={show:function(t){t.visible=!0},hide:function(t){t.visible=!1,t.hidden=!0},auto:function(t){t.visible=!1,t.hidden=!1}},a=function(t,e){t.select("span.genelabel").text(function(t){return t.label}).style("font-weight",function(t){return t.selected?"bold":"normal"}).style("opacity",function(t){return t.visible||t.selected?1:t.normedScore?t.normedScore:t.importance}).style("color",function(t){return e.visible||e.selected?e.color:null});var n=t.select("div.btn-group");footerLinks=n.selectAll("a").data(["show","hide","auto"]),footerLinks.classed("disabled",function(t){return"show"==t&&e.visible||"hide"==t&&e.hidden&&!e.visible||"auto"==t&&!e.hidden&&!e.visible})},i=function(t,e,i){var r=i.data.genesList,l=e.selectAll("p").data(r);t.append("span").text("Cluster"),links=t.append("div.btn-group").selectAll("a").data(["show","hide","auto"]),links.enter().append("a").attr("href","#").text(function(t){return t}).classed("btn btn-small",!0).on("click",function(t){var e=o[t];r.forEach(e),l.each(function(t){var e=d3.select(this);a(e,t)}),d3.event.preventDefault(),n.onAnnotationSelectFunction()});var s=l.enter(),c=s.append("p");c.append("span").classed("genelabel",!0),c.append("div").classed("btn-group",!0),l.each(function(t){var e=d3.select(this),i=e.select("div.btn-group");footerLinks=i.selectAll("a").data(["show","hide","auto"]),footerLinks.enter().append("a").attr("href","#").text(function(t){return t}).classed("btn btn-small",!0).on("click",function(i){var r=o[i];r(t),n.onAnnotationSelectFunction(),d3.event.preventDefault(),a(e,t)})}),l.each(function(t){var e=d3.select(this);a(e,t)})},r=function(t,e,a){var i=a.data;t.append("a").attr({href:i.link}).text(i.label),e.append("p").text("Chromosome "+i.chromosome+": "+i.start+"-"+i.end),i.score&&e.append("p").text("Score: "+parseFloat(i.score).toFixed(3)),e.append("hr");var r=e.append("p").style("float","right"),l=function(){footerLinks=r.selectAll("a").data(["show","hide","auto"]),footerLinks.enter().append("a").attr("href","#").text(function(t){return t}).classed("btn btn-small",!0).on("click",function(t){var e=o[t];e(i),n.onAnnotationSelectFunction(),d3.event.preventDefault(),l()}),footerLinks.classed("disabled",function(t){return"show"==t&&i.visible||"hide"==t&&i.hidden&&!i.visible||"auto"==t&&!i.hidden&&!i.visible})};l()},l={};return l.geneAnnotationsPopoverFunction=function(t){var e="geneslist"==t.data.type;log.trace("Gene Annotation Context Menu"),d3.select(n.popoverId).attr("class","popover"),popoverTitle=d3.select(n.popoverId).select(".popover-title"),popoverContent=d3.select(n.popoverId).select(".popover-content"),popoverTitle.selectAll("*").remove(),popoverTitle.text(""),popoverContent.selectAll("*").remove(),popoverContent.text(""),e?i(popoverTitle,popoverContent,t):r(popoverTitle,popoverContent,t);var o=d3.select(this).select("text");$(n.popoverId).modalPopover({target:$(o[0]),parent:$(o[0]),"modal-position":"relative",placement:"right",boundingSize:n.drawing}),$(n.popoverId).modalPopover("show"),$(n.popoverId).on("mousedown mousewheel",function(t){log.trace("popover click"),t.stopPropagation()})},l};var GENEMAP=GENEMAP||{};GENEMAP.GeneAnnotations=function(t){function e(t){t.each(function(t){var e=d3.select(this).selectAll(".gene-annotations").data([t]);e.enter().append("g").attr("class","gene-annotations"),e.attr({transform:"translate("+o.layout.x+","+o.layout.y+")",id:function(t){return"annotation_"+t.number}}),r(e,t),o.border&&l(e),e.exit().remove()})}var n={border:!1,labelRectangles:!1,onAnnotationSelectFunction:$.noop(),onExpandClusterFunction:$.noop(),longestChromosome:100,layout:{width:10,height:100,x:0,y:0},chromosomeWidth:20,annotationMarkerSize:5,annotationLabelSize:5,scale:null,drawing:null},o=_.merge({},n,t),a=null,i=function(){return d3.scale.linear().range([0,o.layout.height]).domain([0,o.longestChromosome])},r=function(t,e){_.pick(o,["onAnnotationSelectFunction","drawing"]);o.popoverId="#clusterPopover",a=GENEMAP.GeneAnnotationPopup(o),log.trace("setupGeneAnnotations");var n=i(),r=t.selectAll("g.gene-annotation").data(e.layout.annotationNodes,function(t){return t.data.id}),l=r.enter().append("g").classed("gene-annotation",!0);l.append("line").classed("midpoint-line",!0),l.append("path").classed("link",!0).attr({d:function(t){return t.data.path}}),o.labelRectangles&&l.append("rect").classed("labella",!0),l.append("text").attr({x:function(t){return t.x+.1*o.annotationLabelSize},y:function(t){return t.y+.4*o.annotationLabelSize}}),r.attr("id",function(t){return"feature_"+t.data.id}),r.classed("selected",function(t){return t.data.selected}),r.select("line.midpoint-line").attr({x1:-(.5*o.chromosomeWidth),y1:function(t){return n(t.data.midpoint)},y2:function(t){return n(t.data.midpoint)},x2:0}),r.select("text").text(function(t){return"gene"==t.data.type?t.data.label:"geneslist"==t.data.type?"("+t.data.genesList.length+")":void 0}),o.labelRectangles&&r.select("rect.labella").attr({fill:"pink",stroke:"none",x:function(t){return t.x},y:function(t){return t.y-t.dy/2},width:function(t){return t.dx},height:function(t){return t.dy}});var s="0.5";GENEMAP.vectorEffectSupport||(s=.5/o.scale),r.select("path.link").style("opacity",function(t){return t.data.visible||t.data.selected?1:t.data.normedScore?t.data.normedScore:t.data.importance}).style("stroke-width",function(t){return s}).style("stroke",function(t){return t.data.visible||t.data.selected?t.data.color:"gray"}),r.select("text").style("font-size",function(t){return(t.data.selected?.2:0)+t.data.fontSize+"px"}).style("font-weight",function(t){return t.data.selected?"bold":"normal"}).style("opacity",function(t){return t.data.visible||t.data.selected?1:t.data.normedScore?t.data.normedScore:t.data.importance}).style("fill",function(t){return t.data.visible||t.data.selected?t.data.color:null}),r.select("text").transition().duration(300).attr({x:function(t){return t.x+.1*o.annotationLabelSize},y:function(t){return t.y+.4*o.annotationLabelSize}}),r.select("path.link").transition().duration(300).attr({d:function(t){return t.data.path}}),r.on("click",function(t){"gene"==t.data.type&&(log.info("gene annotation click"),t.data.selected=!t.data.selected,t.data.selected&&(t.data.visible=!0),o.onAnnotationSelectFunction()),"geneslist"==t.data.type&&(log.trace("geneslist annotation click"),o.onExpandClusterFunction(e,t.data))}),r.on("contextmenu",a.geneAnnotationsPopoverFunction);var c=r.exit();c.remove()},l=function(t){t.select("rect.border").empty()&&t.append("rect").classed("border",!0),t.select("rect.border").attr({width:o.layout.width,height:o.layout.height})};return e.onAnnotationSelectFunction=function(t){return arguments.length?(o.onAnnotationSelectFunction=t,e):o.onAnnotationSelectFunction},e.onExpandClusterFunction=function(t){return arguments.length?(o.onExpandClusterFunction=t,e):o.onExpandClusterFunction},e.layout=function(t){return arguments.length?(o.layout=t,e):o.layout},e.drawing=function(t){return arguments.length?(o.drawing=t,e):o.drawing},e.scale=function(t){return arguments.length?(o.scale=t,e):o.scale},e.longestChromosome=function(t){return arguments.length?(o.longestChromosome=t,e):o.longestChromosome},e.chromosomeWidth=function(t){return arguments.length?(o.chromosomeWidth=t,e):o.chromosomeWidth},e.annotationLabelSize=function(t){return arguments.length?(o.annotationLabelSize=t,e):o.annotationLabelSize},e.annotationMarkerSize=function(t){return arguments.length?(o.annotationMarkerSize=t,e):o.annotationMarkerSize},e};var GENEMAP=GENEMAP||{};GENEMAP.GeneBandsLayout=function(t){var e,n={longestChromosome:100,layout:{width:10,height:100,x:0,y:0},doCluster:!0,nClusters:6,scale:1,nGenesToDisplay:1e3},o=_.merge({},n,t),a=function(){return d3.scale.linear().range([0,o.layout.height]).domain([0,o.longestChromosome])},i=function(t){if("gene"==t.type){var e=t;return result={start:e.start,end:e.end,midpoint:e.midpoint,color:e.color,data:e},result}return"geneslist"==t.type?(maxPosition=t.genesList.reduce(function(t,e){return Math.max(t,e.end)},0),minPosition=t.genesList.reduce(function(t,e){return Math.min(t,e.start)},1/0),result={start:minPosition,end:maxPosition,midpoint:t.midpoint,color:"#0000FF",data:t},result):(log.error("unregconized cluster type"),void log.info(t))},r=function(t){e=a();var n=t.layout.geneBandDisplayClusters,o=n.map(i);return o},l=function(t){var e=t.annotations.allGenes.filter(function(t){return t.globalIndex<o.nGenesToDisplay});log.trace("nGenesToDisplay is "+o.nGenesToDisplay),log.trace("Laying out "+e.length+" genes."),e.sort(function(t,e){return t.midpoint-e.midpoint});for(var n=[],a=0;a<e.length;){for(iDiff=a;iDiff<e.length&&e[a].midpoint==e[iDiff].midpoint;)iDiff++;if(nMatching=iDiff-a,1==nMatching)n.push(e[a]),a++;else{var i=e.slice(a,iDiff),r=i.reduce(function(t,e){return t+e.id.toString()},""),l={genesList:i,midpoint:i[0].midpoint,type:"geneslist",id:r};n.push(l),a=iDiff}}return n.sort(function(t,e){return t.midpoint<e.midpoint}),n};return my={},my.layoutChromosome=function(t){t.layout.geneBandNodes=r(t)},my.computeChromosomeClusters=function(t){ly=t.layout,ly.geneBandClusters=l(t),ly.geneBandDisplayClusters=ly.geneBandClusters.slice()},my.expandAllChromosomeClusters=function(t){ly=t.layout,ly.geneBandDisplayClusters=t.annotations.allGenes},my.collapseAllChromosomeClusters=function(t){ly=t.layout,ly.geneBandDisplayClusters=ly.geneBandClusters.slice()},my.expandAChromosomeCluster=function(t,e){ly=t.layout,ly.geneBandDisplayClusters=ly.geneBandClusters.slice(),e.genesList.forEach(function(t){ly.geneBandDisplayClusters.push(t)});var n=ly.geneBandDisplayClusters.indexOf(e);ly.geneBandDisplayClusters.splice(n,1)},my};var GENEMAP=GENEMAP||{};GENEMAP.GeneClusterer=function(t){var e={},n={nClusters:6},o=_.merge({},n,t);return e.createClustersFromGenes=function(t){var e=[];if(t.length<1)return e;var n=Math.min(o.nClusters,t.length),a=t.map(function(t){return t.midpoint});clusterPointsList=ss.ckmeans(a,n);
for(var i=[],r=0;r<clusterPointsList.length;r++)i.push([]);return t.map(function(t){iCluster=clusterPointsList.findIndex(function(e){return e.includes(t.midpoint)}),i[iCluster].push(t)}),i.map(function(t){if(t.length<2)e.push.apply(e,t);else{var n=t.reduce(function(t,e){return t+e.midpoint},0)/t.length,o=t.reduce(function(t,e){return t+e.id.toString()},""),a={genesList:t,midpoint:n,type:"geneslist",id:o.toString()};e.push(a)}}),e},e.nClusters=function(t){return arguments.length?(o.nClusters=t,e):o.nClusters},e};var GENEMAP=GENEMAP||{};GENEMAP.vectorEffectSupport=!0,GENEMAP.Listener=function(t){var e=t,n=[],o=function(t){return arguments.length?(e=t,void n.forEach(function(t){t(e)})):e};return o.addListener=function(t){return n.push(t),o},o.removeListener=function(t){return _.pull(n,t),o},o},GENEMAP.GeneMap=function(t){function e(t){t.each(function(t){var o=this;n=o,d=t,u=d,h=!1,p||(p=GENEMAP.MenuBar().onTagBtnClick(V).onFitBtnClick(A).onLabelBtnClick(D).onQtlBtnClick(H).onNetworkBtnClick(Q).onResetBtnClick(W).onSetNumberPerRowClick(I).initialMaxGenes(b.nGenesToDisplay).initialNPerRow(b.layout.numberPerRow).onExportBtnClick(G).onExportAllBtnClick(M).onExpandBtnClick(E).maxSnpPValueProperty(e.maxSnpPValue).nGenesToDisplayProperty(e.nGenesToDisplay).annotationLabelSizeProperty(e.annotationLabelSize)),d3.select(n).call(p),p.setNetworkButtonEnabled(!1),p.setFitButtonEnabled(!1),p.setTabButtonState("auto"),Z()})}var n,o,a,i,r,l,s,c,u,d,h,p,f,m,g,v,y={width:"800",height:"500",svgDefsFile:"./assets/sprite-defs.svg",layout:{margin:{top:.05,right:.05,bottom:.05,left:.05},numberPerRow:7,maxAnnotationLayers:3},pngScale:2,contentBorder:!1,initialMaxGenes:200,nGenesToDisplay:200,maxSnpPValue:1e-5,annotationLabelSize:13,extraPanArea:.4},b=_.merge({},y,t),x=!1,w={},P=function(){if(x){var t=$(n).height();b.height=t-80,b.width="100%"}},E=function(){d3.select(n);x?(b.height=w.height,b.width=w.width,d3.select(n).classed("fullscreen",!1),x=!1):(w.height=b.height,w.width=b.width,d3.select(n).classed("fullscreen",!0),x=!0),P(),F(),A(),Z()},C=function(){var t={width:b.width,height:b.height};if(t.width.toString().indexOf("%")>=0||t.height.toString().indexOf("%")>=0){var e=d3.select(n).select("svg").node().getBoundingClientRect();t.width.toString().indexOf("%")>=0&&(t.width=e.width),t.height.toString().indexOf("%")>=0&&(t.height=e.height)}return t},k=function(){var t=!1;return l&&(t=0!==l.translate()[0]||0!==l.translate()[1]||t,t=1!==l.scale()||t),t},A=function(){1==l.scale()&&_.isEqual(l.translate(),[0,0])||(l.translate([0,0]),l.scale(1),a.attr("transform","translate("+l.translate()+")scale("+l.scale()+")"),p.setFitButtonEnabled(k()),U(),Z())},L=function(){a.select(".drawing_outline").attr({width:u.drawing.width,height:u.drawing.height})},S=function(){var t=u.drawing,e=u.margin;a.select(".drawing_margin").attr({x:e.left,y:e.top,width:t.width-e.left-e.right,height:t.height-e.top-e.bottom})},M=function(){log.info("Exporting whole canvas to png, scale is "+l.scale()),a.attr("transform","translate(0,0)scale(1)"),saveSvgAsPng(a[0][0],"genemap.png",{scale:l.scale()*b.pngScale}),a.attr("transform","translate("+l.translate()+")scale("+l.scale()+")")},G=function(){log.info("Exporting view to png, scale is "+l.scale()),saveSvgAsPng(o[0][0],"genemap.png",{scale:b.pngScale})};s=function(){var t=d3.event.translate;if(u){var e=o.node().getBoundingClientRect(),n=-u.drawing.width*d3.event.scale+e.width*(1-b.extraPanArea)+u.drawing.margin.right*d3.event.scale,r=e.width*b.extraPanArea-u.drawing.margin.left*d3.event.scale;t[0]=_.clamp(t[0],n,r);var s=-u.drawing.height*d3.event.scale+e.height*(1-b.extraPanArea)+u.drawing.margin.bottom*d3.event.scale,d=e.height*b.extraPanArea-u.drawing.margin.top*d3.event.scale;t[1]=_.clamp(t[1],s,d)}l.translate(t),l.scale()!=c&&(log.trace("New zoom"),U(),Z()),c=l.scale(),p.setFitButtonEnabled(k()),a.attr("transform","translate("+l.translate()+")scale("+d3.event.scale+")"),i.text("translate: [ "+l.translate()[0].toFixed(1)+","+l.translate()[1].toFixed(1)+"]  zoom:"+l.scale().toFixed(2))};var N=function(){log.trace("mouse down"),o.classed("dragging",!0)},z=function(){log.trace("mouse up"),o.classed("dragging",!1)},B=function(){log.trace("context click"),d3.event.preventDefault()},F=function(t){$("#clusterPopover").modalPopover("hide"),$(".genemap-advanced-menu").modalPopover("hide")},T=function(){var t=function(t){"a"!==t.target.tagName.toLowerCase()&&($(t.target).closest(".genemap-advanced-menu").length>0||F(t))},e="mousedown mousewheel DOMMouseScroll touchstart ";$(n).off(e).on(e,t),$("body").on("click",function(t){$(t.target).closest(n).length<1&&1==x&&E()})},D=function(t){"auto"==t?(f=!0,m=!0,u.chromosomes.forEach(function(t){t.annotations.genes.forEach(function(t){1==t.selected&&(t.visible=!0)})})):"show"==t?(f=!1,m=!0):"hide"==t&&(f=!1,m=!1),u.chromosomes.forEach(function(e){e.annotations.genes.forEach(function(e){"auto"===t?delete e.showLabel:e.showLabel=t})}),U(),Z()},q=function(){var t=u.chromosomes.some(function(t){return t.annotations.genes.some(function(t){return t.selected})});U(),Z(),d3.select(".network-btn").classed("disabled",!t)},R=function(t){h?(u=d,h=!1):(u={chromosomes:[t]},h=!0),A(),U(),Z()},Q=function(){var t=_.flatMap(u.chromosomes.map(function(t){return t.annotations.genes.filter(function(t){return t.selected}).map(function(t){var e=t.link,n=e.substring(e.indexOf("list="),e.length).split("=")[1];return n})})),e="OndexServlet?mode=network&keyword="+$("#keywords").val();log.info("selected labels: "+t),generateCyJSNetwork(e,{list:t.join("\n")})},V=function(){var t,e=p.getTagButtonState();t="auto"===e?"show":"show"===e?"hide":"auto",p.setTabButtonState(t),D(t),Z()},W=function(){log.info("Reset Labels"),u.chromosomes.forEach(function(t){t.annotations.allGenes.forEach(function(t){t.selected=!1,t.visible=!1,t.hidden=!1})}),U(),Z()},I=function(t){log.trace("Number per row:",t),b.layout.numberPerRow=t,X(),U(),Z()},H=function(t){log.info("onToggleQTLDisplay"),"all"==t?(g=!0,v=!0):"selected"==t?(g=!1,v="true"):(g=!1,v=!1),j(),U(),Z()},O=function(){var t=GENEMAP.AutoLayoutDecorator(b.layout).width(C().width).height(C().height).scale(l.scale());u=t.decorateGenome(u)},X=function(){u.chromosomes.forEach(function(t){t.layout=t.layout||{},t.layout.annotationDisplayClusters=null,t.layout.geneBandDisplayClusters=null})},j=function(){u.chromosomes.forEach(function(t){t.layout=t.layout||{},t.layout.qtlDisplayClusters=null})},U=function(){O();var t=(u.chromosomes.length>1,GENEMAP.GeneAnnotationLayout({longestChromosome:u.cellLayout.longestChromosome,layout:u.cellLayout.geneAnnotationPosition,annotationMarkerSize:u.cellLayout.annotations.marker.size,annotationLabelSize:u.cellLayout.annotations.label.size,scale:l.scale(),autoLabels:f,manualLabels:m,nGenesToDisplay:b.nGenesToDisplay,displayedFontSize:b.annotationLabelSize})),e=GENEMAP.GeneBandsLayout({longestChromosome:u.cellLayout.longestChromosome,layout:u.cellLayout.geneAnnotationPosition,nClusters:50,scale:l.scale(),nGenesToDisplay:b.nGenesToDisplay}),n=GENEMAP.QTLAnnotationLayout({longestChromosome:u.cellLayout.longestChromosome,layout:u.cellLayout.qtlAnnotationPosition,scale:l.scale(),showAllQTLs:g,showSelectedQTLs:v,showAutoQTLLabels:g,showSelectedQTLLabels:v,annotationLabelSize:u.cellLayout.annotations.label.size});u.chromosomes.forEach(function(o){o.layout=o.layout||{},o.layout.annotationDisplayClusters||t.computeChromosomeClusters(o),t.layoutChromosome(o),o.layout.geneBandDisplayClusters||e.computeChromosomeClusters(o),e.layoutChromosome(o),o.layout.qtlDisplayClusters||n.computeChromosomeClusters(o),n.layoutChromosome(o)}),t.computeNormalisedGeneScores(u.chromosomes)},J=function(t,e){var n=new Set,o=[];e.chromosomes.forEach(function(t){t.annotations.snps.forEach(function(t){n.has(t.trait)||null!=t.trait&&o.push({trait:t.trait,color:t.color}),n.add(t.trait)})}),o.length>0?t.text("SNP legend: "):t.text("");var a=t.selectAll("span").data(o),i=a.enter().append("span").classed("key-item",!0);i.append("span").style("background-color",function(t){return t.color}).classed("colorbox",!0).append("svg"),i.append("span").text(function(t){return t.trait}),a.exit().remove()},K=function(t){var e=t.append("svg").attr({width:b.width,height:b.height,"class":"mapview"});i=t.append("div").append("span").attr({"class":"logger",id:"logbar"}),r=t.append("div").attr({"class":"key",id:"keybar"}),GENEMAP.vectorEffectSupport="vectorEffect"in e[0][0].style,T(),e.on("mousedown",N).on("mouseup",z).on("contextmenu",B),e.append("g").classed("zoom_window",!0).append("rect").classed("drawing_outline",!0),b.contentBorder&&t.select(".zoom_window").append("rect").classed("drawing_margin",!0),c=1,l=d3.behavior.zoom().scaleExtent([1,50]),l.on("zoom",s),t.select("svg").call(l);var n=t.append("div").attr({id:"clusterPopover","class":"popover"});return n.append("div").attr({"class":"arrow"}),n.append("h3").attr({"class":"popover-title"}).text("Cluster"),n.append("div").attr({"class":"popover-content"}),e},Z=function(){d3.select(n).select("svg").node()?(o=d3.select(n).select("svg"),o.attr({width:b.width,height:b.height})):o=K(d3.select(n)),i.text("translate: [ "+l.translate()[0].toFixed(1)+","+l.translate()[1].toFixed(1)+"]  zoom:"+l.scale().toFixed(2)),O();var t=u.chromosomes.every(function(t){return t.layout});t||U(),o.datum(u),a=o.select(".zoom_window"),L(),b.contentBorder&&S();var e=GENEMAP.ChromosomeCell().onAnnotationSelectFunction(q).onLabelSelectFunction(R).maxAnnotationLayers(b.layout.maxAnnotationLayers).maxSnpPValue(b.maxSnpPValue).svg(o);a.call(e)};return e.resetZoom=A,e.width=function(t){return arguments.length?(b.width=t,e):b.width},e.height=function(t){return arguments.length?(b.height=t,e):b.height},e.layout=function(t){return arguments.length?(b.layout=_.merge(b.layout,t),e):b.layout},e.draw=function(t,o,a){var i=GENEMAP.XmlDataReader(),l=d3.select(t).selectAll("div").data(["genemap-target"]);l.enter().append("div").attr("id",function(t){return t}),n=d3.select(t).select("#genemap-target")[0][0],i.readXMLData(o,a).then(function(t){log.info("drawing genome to target"),d3.select(n).datum(t).call(e),e.nGenesToDisplay(b.initialMaxGenes),A(),J(r,u)})},e.redraw=function(t){n=d3.select(t).select("#genemap-target")[0][0],P(),d3.select(n).call(e),F()},e.setGeneLabels=function(t){n&&D(t)},e.maxSnpPValue=GENEMAP.Listener(b.maxSnpPValue).addListener(function(t){var n=Number(t);log.info("Setting max PValue for SNPs to",t,"(",n,")"),isNaN(n)&&(log.info("Can't parse max PValue"),e.maxSnpPValue(b.maxSnpPValue)),b.maxSnpPValue=Number(t),U(),Z()}),e.nGenesToDisplay=GENEMAP.Listener(b.nGenesToDisplay).addListener(function(t){log.info("Setting nGenes to ",t);var e=b.nGenesToDisplay;b.nGenesToDisplay=t,t!=e&&(X(),U(),Z())}),e.annotationLabelSize=GENEMAP.Listener(b.annotationLabelSize).addListener(function(t){log.info("Setting annotation label size to",t),b.annotationLabelSize=t,X(),U(),Z()}),e.setQtlLabels=function(t){if(n){var e=d3.select(n).datum();e.chromosomes.forEach(function(e){e.annotations.qtls.forEach(function(e){"auto"===t?delete e.showLabel:e.showLabel=t})})}},e.loggingOn=function(){i.style("display","initial")},e.loggingOff=function(){i.style("display","none")},e},function(t){var e=function(t,e,n){this.distance=t,this.linkage=e,this.threshold=void 0==n?1/0:n};e.prototype={cluster:function(t,e,n){this.clusters=[],this.dists=[],this.mins=[],this.index=[];for(var o=0;o<t.length;o++){var a={value:t[o],key:o,index:o,size:1};this.clusters[o]=a,this.index[o]=a,this.dists[o]=[],this.mins[o]=0}for(var o=0;o<this.clusters.length;o++)for(var i=0;i<=o;i++){var r=o==i?1/0:this.distance(this.clusters[o].value,this.clusters[i].value);this.dists[o][i]=r,this.dists[i][o]=r,r<this.dists[o][this.mins[o]]&&(this.mins[o]=i)}for(var l=this.mergeClosest(),o=0;l;)n&&o++%e==0&&n(this.clusters),l=this.mergeClosest();return this.clusters.forEach(function(t){delete t.key,delete t.index}),this.clusters},mergeClosest:function(){for(var t=0,e=1/0,n=0;n<this.clusters.length;n++){var o=this.clusters[n].key,a=this.dists[o][this.mins[o]];a<e&&(t=o,e=a)}if(e>=this.threshold)return!1;var i=this.index[t],r=this.index[this.mins[t]],l={left:i,right:r,key:i.key,size:i.size+r.size};this.clusters[i.index]=l,this.clusters.splice(r.index,1),this.index[i.key]=l;for(var n=0;n<this.clusters.length;n++){var a,s=this.clusters[n];i.key==s.key?a=1/0:"single"==this.linkage?(a=this.dists[i.key][s.key],this.dists[i.key][s.key]>this.dists[r.key][s.key]&&(a=this.dists[r.key][s.key])):"complete"==this.linkage?(a=this.dists[i.key][s.key],this.dists[i.key][s.key]<this.dists[r.key][s.key]&&(a=this.dists[r.key][s.key])):a="average"==this.linkage?(this.dists[i.key][s.key]*i.size+this.dists[r.key][s.key]*r.size)/(i.size+r.size):this.distance(s.value,i.value),this.dists[i.key][s.key]=this.dists[s.key][i.key]=a}for(var n=0;n<this.clusters.length;n++){var c=this.clusters[n].key;if(this.mins[c]==i.key||this.mins[c]==r.key){for(var e=c,u=0;u<this.clusters.length;u++){var d=this.clusters[u].key;this.dists[c][d]<this.dists[c][e]&&(e=d)}this.mins[c]=e}this.clusters[n].index=n}return delete i.key,delete r.key,delete i.index,delete r.index,!0}};var n=function(t,n,o,a,i,r){o=o||"average";var l=new e(n,o,a).cluster(t,i,r);return void 0===a?l[0]:l};t.hcluster=n}(this.hcluster={});var GENEMAP=GENEMAP||{};GENEMAP.MenuBar=function(t){function e(t){t.each(function(t){var e=this;n=e,d()})}var n,o={onNetworkBtnClick:$.noop,onFitBtnClick:$.noop,onTagBtnClick:$.noop,onLabelBtnClick:$.noop,onQtlBtnClick:$.noop,onResetBtnClick:$.noop,onSetNumberPerRowClick:$.noop,onExportBtnClick:$.noop,onExportAllBtnClick:$.noop,onExpandBtnClick:$.noop,maxSnpPValueProperty:$.noop,nGenesToDisplayProperty:$.noop,annotationLabelSizeProperty:$.noop,initialMaxGenes:200,initialNPerRow:10},a=_.merge({},o,t),i=function(){$(this).hasClass("disabled")||a.onNetworkBtnClick()},r=function(){$(this).hasClass("disabled")||a.onTagBtnClick()},l=function(){$(this).hasClass("disabled")||a.onFitBtnClick()},s=function(){$(this).hasClass("disabled")||($("#select-label-btn").selectpicker("val","Auto labels").change(),$("#select-qtl-btn").selectpicker("val","All QTLs").change(),a.onResetBtnClick())},c=function(){a.onExpandBtnClick()},u=function(t,e,n,o,a){var i="select-"+e,r=t.selectAll("select").data([null]);r.enter().append("select").attr({id:i,name:i,"class":"myselectpicker"});var l=r.selectAll("option").data(n);l.enter().append("option").attr("data-token",function(t){return t[1]}).text(function(t){return t[0]});var s=$("#"+i).selectpicker({width:"130px"});s.selectpicker("val",a),s.selectpicker("refresh"),s.on("change",function(t){var e=s.find("option:selected"),n=e.data().token;o(n)})},d=function(){var t=d3.select(n).selectAll(".genemap-menu").data([null]);t.enter().append("div").classed("genemap-menu",!0);var e=t.selectAll("span").data([["network-btn","expand-btn","reset-btn"],["label-btn","ngenes-dropdown"],["fit-btn","export-btn","advanced-toggle","help-btn"]]).enter().append("span").classed("menu-block",!0),o=e.selectAll("span").data(function(t,e){return t});o.enter().append("span"),o.attr({"class":function(t){return t}}),t.select(".network-btn").attr("title","Launch network view").on("click",i),t.select(".tag-btn").on("click",r);var d=t.select(".label-btn");u(d,"label-btn",[["Auto labels","auto"],["Checked labels","show"],["No labels","hide"]],a.onLabelBtnClick,"Auto labels"),t.select(".fit-btn").attr("title","Reset pan and zoom").on("click",l),t.select(".reset-btn").attr("title","Reset selections").on("click",s);var h=t.select(".ngenes-dropdown");h.text(""),u(h,"ngenes-dropdown",[["50 genes",50],["100 genes",100],["200 genes",200],["500 genes",500],["1000 genes",1e3]],a.nGenesToDisplayProperty,a.nGenesToDisplayProperty()+" genes"),a.nGenesToDisplayProperty.addListener(function(t){$("#select-ngenes-dropdown").selectpicker("val",[t+" genes",t])}),t.select(".export-btn").attr({title:"Export view to png"}).on("click",a.onExportBtnClick),t.select(".expand-btn").attr("title","Toggle full screen").on("click",c),t.select(".advanced-toggle").attr("title","Show advanced options").on("click",function(){$(".genemap-advanced-menu").modalPopover("toggle")});var p="https://github.com/francis-newson-tessella/QTLNetMiner/tree/QTLNM-47-MVE/common/client/src/main/webapp/html/GeneMap/docs";t.select(".help-btn").attr({title:"help"}).on("click",function(){window.open(p,"_blank")});var f=d3.select(n).selectAll(".genemap-advanced-menu").data([null]);popoverDiv=f.enter().append("div").classed("genemap-advanced-menu",!0).classed("popover",!0),popoverDiv.append("div").attr({"class":"arrow"}),popoverHeading=popoverDiv.append("h3").attr({"class":"popover-title"}).text("Advanced options"),popoverHeading.append("button").attr({"class":"close"}).on("click",function(){$(".genemap-advanced-menu").modalPopover("toggle")}).append("span").html("&times"),popoverDiv.append("div").classed("popover-content",!0);var m=f.select(".popover-content").selectAll("div").data(["qtl-btn","nperrow-spinner","max-snp-pvalue","labelsize","export-all-btn"]);m.enter().append("div").attr("class",function(t){return t});var g=f.select(".qtl-btn");u(g,"qtl-btn",[["All QTLs","all"],["Checked QTLs","selected"],["No QTLs","none"]],a.onQtlBtnClick,"All QTLs");var v=f.select(".max-snp-pvalue").selectAll("form").data([""]).enter(),y=v.append("form").classed("bootstrap",!0).attr({id:"snp-pvalue-form","class":"bootstrap form-inline"});y.append("label").attr({id:"max-snp-pvalue-text","for":"max-snp-pvalue-input"}).html("Max SNP p-value:&nbsp"),y.append("input").attr({"class":"form-control",id:"max-snp-pvalue-input",type:"text",value:a.maxSnpPValueProperty()}),y.append("button").attr({"class":"btn btn-default",type:"submit"}).text("Set"),$("#snp-pvalue-form").submit(function(t){a.maxSnpPValueProperty($("#max-snp-pvalue-input").val()),t.preventDefault()}),a.maxSnpPValueProperty.addListener(function(t){$("#max-snp-pvalue-input").val(t)});var b=f.select(".nperrow-spinner"),x=b.selectAll("input").data(["nPerRowSpinner"]).enter();x.append("span").append("label").classed("bootstrap",!0).attr({"for":function(t){return t}}).html("Num per row:&nbsp;"),x.append("span").append("input").attr({id:function(t){return t},type:"text",value:a.initialNPerRow,name:function(t){return t}});var w=b.select("input"),P=$(w);P.TouchSpin({min:1,max:20,step:1}),d3.select(".nperrow-spinner").select(".input-group").style({width:"8em",display:"inline-table"}),$("#nPerRowSpinner").on("change",function(t){a.onSetNumberPerRowClick($("#nPerRowSpinner").val())}),f.select(".export-all-btn").attr({title:"export all to png"}).on("click",a.onExportAllBtnClick),f.select(".labelsize").selectAll("span").data(["labelsize-label","labelsize-dropdown"]).enter().append("span").attr({"class":function(t){return t}}),f.select(".labelsize-label").classed("bootstrap",!0),f.select(".labelsize-label").selectAll("label").data([""]).enter().append("label").text("Label size:");var E=f.select(".labelsize-dropdown");E.text(""),u(E,"labelsize-dropdown",[["10",10],["15",15],["20",20],["25",25]],a.annotationLabelSizeProperty,a.annotationLabelSizeProperty()),a.annotationLabelSizeProperty.addListener(function(t){$("#select-labelsize-dropdown").selectpicker("val",[t,t])}),$(".genemap-advanced-menu").modalPopover({target:$(".advanced-toggle"),parent:$(".advanced-toggle"),"modal-position":"relative",placement:"bottom",boundingSize:a.drawing})};return e.onNetworkBtnClick=function(t){return arguments.length?(a.onNetworkBtnClick=t,e):a.onNetworkBtnClick},e.onTagBtnClick=function(t){return arguments.length?(a.onTagBtnClick=t,e):a.onTagBtnClick},e.onLabelBtnClick=function(t){return arguments.length?(a.onLabelBtnClick=t,e):a.onLabelBtnClick},e.onQtlBtnClick=function(t){return arguments.length?(a.onQtlBtnClick=t,e):a.onQtlBtnClick},e.onFitBtnClick=function(t){return arguments.length?(a.onFitBtnClick=t,e):a.onFitBtnClick},e.onResetBtnClick=function(t){return arguments.length?(a.onResetBtnClick=t,e):a.onResetBtnClick},e.onSetNumberPerRowClick=function(t){return arguments.length?(a.onSetNumberPerRowClick=t,e):a.onSetNumberPerRowClick},e.initialMaxGenes=function(t){return arguments.length?(a.initialMaxGenes=t,e):a.initialMaxGenes},e.initialNPerRow=function(t){return arguments.length?(a.initialNPerRow=t,e):a.initialNPerRow},e.onExportBtnClick=function(t){return arguments.length?(a.onExportBtnClick=t,e):a.onExportBtnClick},e.onExportAllBtnClick=function(t){return arguments.length?(a.onExportAllBtnClick=t,e):a.onExportAllBtnClick},e.onExpandBtnClick=function(t){return arguments.length?(a.onExpandBtnClick=t,e):a.onExpandBtnClick},e.maxSnpPValueProperty=function(t){return arguments.length?(a.maxSnpPValueProperty=t,e):a.maxSnpPValueProperty},e.nGenesToDisplayProperty=function(t){return arguments.length?(a.nGenesToDisplayProperty=t,e):a.nGenesToDisplayProperty},e.annotationLabelSizeProperty=function(t){return arguments.length?(a.annotationLabelSizeProperty=t,e):a.annotationLabelSizeProperty},e.setTabButtonState=function(t){var e=d3.select(n).select(".tag-btn");"show"===t?(e.classed("show-label",!0),e.classed("hide-label",!1),e.classed("auto-label",!1),e.classed("manual-label",!1),e.attr("title","Show Labels")):"hide"===t?(e.classed("show-label",!1),e.classed("hide-label",!0),e.classed("auto-label",!1),e.classed("manual-label",!1),e.attr("title","Hide Labels")):"manual"===t?(e.classed("show-label",!1),e.classed("hide-label",!1),e.classed("auto-label",!1),e.classed("manual-label",!0),e.attr("title","Manual Labels")):(e.classed("show-label",!1),e.classed("hide-label",!1),e.classed("auto-label",!0),e.classed("manual-label",!1),e.attr("title","Automatic Labels"))},e.getTagButtonState=function(){var t=d3.select(n).select(".tag-btn");return t.classed("show-label")?"show":t.classed("hide-label")?"hide":t.classed("auto-label")?"auto":"manual"},e.setFitButtonEnabled=function(t){d3.select(n).select(".fit-btn").classed("disabled",!t)},e.setNetworkButtonEnabled=function(t){d3.select(n).select(".network-btn").classed("disabled",!t)},e};var GENEMAP=GENEMAP||{};GENEMAP.QTLAnnotationCombiner=function(){return{combineSimilarQTLAnnotations:function(t){var e=[],n={};return t.forEach(function(t){var e=t.start+"-"+t.end;n.hasOwnProperty(e)||(n[e]=[]),n[e].push(t)}),_.forEach(n,function(t,n){var o={qtlList:t,count:t.length,start:t[0].start,midpoint:t[0].midpoint,end:t[0].end,type:"qtllist",id:n};e.push(o)}),e}}};var GENEMAP=GENEMAP||{};GENEMAP.QtlAnnotations=function(t){function e(t){t.each(function(t){var e=t.annotations.snps.filter(function(t){return!(t.pvalue>o.maxSnpPValue)}),n=s(e),a=d3.select(this).selectAll(".qtl-annotations").data([t]);a.enter().append("g").attr("class","qtl-annotations"),a.attr({transform:"translate("+o.layout.x+","+o.layout.y+")"}),r(a,t,n.length),o.border&&l(a),a.exit().remove();var c=d3.select(this).selectAll(".snp-annotations").data([t]);c.enter().append("g").attr("class","snp-annotations"),c.attr({transform:"translate("+o.layout.x+","+o.layout.y+")"}),i(c,t,e,n),c.exit().remove()})}var n={border:!1,onAnnotationSelectFunction:$.noop(),longestChromosome:100,layout:{width:10,height:100,x:0,y:0},bandWidthPercentage:1/8,gapPercentage:1/15,chromosomeWidth:20,annotationMarkerSize:5,annotationLabelSize:5,showAnnotationLabels:!0,maxSnpPValue:1,drawing:null,scale:1},o=_.merge({},n,t),a=function(){return d3.scale.linear().range([0,o.layout.height]).domain([0,o.longestChromosome])},i=function(t,e,n,i){var r={};i.map(function(t,e){r[t]=e});var l=a(),s=t.selectAll("rect.snp-annotation").data(n,function(t){return t.id}),c=4,u=function(t){return o.layout.width-.2*o.layout.chromosomeWidth*(1+r[t.trait])},d=function(t){return l(t.midpoint)-.5*Math.max(c/o.scale,l(10))},h=Math.max(c/o.scale,l(10)),p=.2*o.layout.chromosomeWidth;s.attr({x:u,y:d,width:p,height:h}),s.enter().append("rect").attr({fill:function(t){return t.color},opacity:function(t){return t.importance},"class":"snp-annotation",x:u,y:d,width:p,height:h}),s.exit().remove(),s.on("contextmenu",function(t){log.trace("SNP Context Menu");var n=d3.select("#clusterPopover");n.attr("class","popover");var a=n.select(".popover-title");a.selectAll("*").remove(),a.text("");var i=n.select(".popover-content");i.selectAll("*").remove(),i.text(""),a.append("span").text("SNP: "),a.append("a").attr("href",t.link).text(t.label);var r=i.selectAll("p").data([["Chromsome "+e.number,t.midpoint],["p-value",Number(t.pvalue).toExponential()],["Trait",t.trait]]),l=r.enter();l.append("p").classed("popover-annotation",!0).text(function(t){return t[0]+": "+t[1]}),$clusterPopover=$("#clusterPopover"),$clusterPopover.modalPopover({target:$(this),$parent:$(this),"modal-position":"body",placement:"left",boundingSize:o.drawing}),$clusterPopover.modalPopover("show"),$clusterPopover.on("mousedown mousewheel",function(t){log.info("popover click"),t.stopPropagation()})})},r=function(t,e,n){var i=500,l=a(),s=(o.layout.width,.3*o.layout.chromosomeWidth),c=.4*o.layout.chromosomeWidth,u=e.layout.qtlNodes.some(function(t){return t.displayLabel});u&&(c=1.5*c);var d=.2*n*o.layout.chromosomeWidth,h=function(t){return o.layout.width-t.labelPosition*(c+s)-d},p=function(t){return o.layout.width-t.position*(c+s)-d},f=t.selectAll("g.qtl-annotation").data(e.layout.qtlNodes,function(t){return t.id}),m=f.enter().append("g").classed("qtl-annotation infobox",!0);m.append("rect").classed("qtl-hoverbox",!0);var g=m.append("rect").classed("qtl-selector infobox",!0),v={},y={};f.exit().select("rect").each(function(t){v[t.index]=_.pick(this,["x","y","width","height"]),v[t.index].midpoint=t.midpoint,v[t.index].position=t.position}),g.each(function(t){y[t.index]=_.pick(this,["x","y","width","height"]),y[t.index].midpoint=t.midpoint,y[t.index].position=t.position});var b=function(t,e,n,o){return _.has(t,e)?t[e][n].animVal.value:o};g.attr({x:function(t){return b(v,t.parentIndex,"x",p(t))},y:function(t){return b(v,t.parentIndex,"y",l(t.start))},width:s,height:function(t){return b(v,t.parentIndex,"height",l(t.end)-l(t.start))}}),f.attr("id",function(t){return"feature_"+t.id}),f.select("rect.qtl-hoverbox").attr({x:function(t){return p(t)},y:function(t){return l(t.start)},width:function(t){return t.position*(c+s)+o.chromosomeWidth+d},height:function(t){return l(t.end)-l(t.start)},fill:function(t){return t.color},visibility:function(t){return t.hover?"visible":"hidden"}}),f.select("rect.qtl-selector").transition().duration(i).attr({x:p,y:function(t){return l(t.start)},width:s,height:function(t){return l(t.end)-l(t.start)}}),f.select("rect.qtl-selector").style({fill:function(t){return t.color}}),debugQtlLableBoxes=!1,debugQtlLableBoxes&&f.select("rect.test").attr({x:function(t){return t.displayLabel?h(t):0},y:function(t){return t.displayLabel?l(t.midpoint)-.6*t.screenLabel.length*o.annotationLabelSize/2:0},width:function(t){return s},height:function(t){return t.displayLabel?.6*t.screenLabel.length*o.annotationLabelSize:0},fill:function(t){return"pink"}}),f.exit().select("rect").transition().duration(i).attr({x:function(t){return b(y,t.parentIndex,"x",p(t))},y:function(t){return b(y,t.parentIndex,"y",l(t.start))},width:s,height:function(t){return b(y,t.parentIndex,"height",l(t.end)-l(t.start))}}).remove(),f.exit().remove();var x=function(t){return l(t.midpoint)},w=function(t){return"show"===t.displayLabel?"visible":"hide"!==t.displayLabel||"hidden"},P=m.append("g").classed("qtl-count-group",!0),E=f.select("g.qtl-count-group").selectAll("g.qtllist").data(function(t){var e="qtllist"==t.type?[t]:[];return e},function(t){return"label_"+t.id}),C=E.enter(),k=C.append("g").classed("qtllist",!0);k.append("circle").classed("qtl-count",!0),k.append("text").classed("qtl-count",!0),P.each(function(t){if(_.has(y,t.index))if(_.has(v,t.parentIndex)){oldNode=v[t.parentIndex];var e=o.layout.width-oldNode.position*(c+s),n=l(oldNode.midpoint);d3.select(this).attr({transform:"translate("+(e+.5*s)+","+n+")"})}else d3.select(this).attr({transform:function(t){return t?"translate("+(p(t)+.5*s)+","+x(t)+")":"translate(0,0)"}})}),f.select("g.qtl-count-group").transition().duration(i).attr({transform:function(t){return t?"translate("+(p(t)+.5*s)+","+x(t)+")":"translate(0,0)"}}),f.select("circle.qtl-count").attr({cx:0,cy:0,r:s+"px"}).style({visibility:"visible",fill:function(t){return t.color}}).attr({id:function(t){return t.id}});var A=Math.min(Math.max(10/o.scale,s),14/o.scale);f.select("text.qtl-count").attr({x:0,y:0,dy:"0.3em","text-anchor":"middle"}).style({fill:"white","font-size":A+"px",visibility:A<2*s?"visible":"hidden"}).text(function(t){return t.count}),E.exit().remove(),m.append("g").classed("qtl-label-group",!0);var L=f.select("g.qtl-label-group").selectAll("g.qtl").data(function(t){var e=t.displayLabel?[t]:[];return e},function(t){return"label_"+t.id});L.exit().remove(),L.transition().duration(i).attr({transform:function(t){return"translate("+(h(t)+.5*s)+","+x(t)+")"}});var S=L.enter(),M=S.append("g").classed("qtl",!0).attr({transform:function(t){return"translate("+(h(t)+.5*s)+","+x(t)+")"}});M.append("text").classed("qtl-label",!0),f.select("text.qtl-label").attr({x:0,y:0,dy:"0.3em","text-anchor":"middle"}).style({"font-size":function(t){return t.fontSize+"px"}}).attr({transform:"rotate(270)",visibility:w}).text(function(t){return t.screenLabel});var G=function(o){o.on("mouseenter",function(o){o.hover=!0,r(t,e,n)}).on("mouseout",function(o){o.hover=!1,r(t,e,n)}).on("click",function(o){o.hover=!o.hover,r(t,e,n)})};G(f.select("rect.qtl-selector")),G(f.select("circle.qtl-count")),G(f.select("text.qtl-count")),f.on("contextmenu",function(t){log.trace("Gene Annotation Context Menu");var e=d3.select("#clusterPopover");e.attr("class","popover");var n=e.select(".popover-title");n.selectAll("*").remove(),n.text(""),n.text("Chromosome "+t.chromosome+": "+t.start+"-"+t.end),$.fn.redraw=function(){return $(this).each(function(){this.offsetHeight})},a=e.select(".popover-content"),a.selectAll("*").remove(),a.text("");var a=e.select(".popover-content").selectAll("p").data("qtllist"==t.type?t.qtlList:[t]),i=a.enter();i.append("p").classed("popover-annotation",!0);var r=a.append("div").attr({"class":"checkbox"}).append("label");r.append("input").attr({type:"checkbox",value:""}).property("checked",function(t){return t.selected}).on("click",function(t){t.selected=!t.selected,a.classed("selected",function(t){return t.selected}),o.onAnnotationSelectFunction()}),r.append("a").attr({href:function(t){return t.link},target:"_blank"}).text(function(t){return t.label}),a.classed("selected",function(t){return t.selected}),$clusterPopover=$("#clusterPopover"),$clusterPopover.modalPopover({target:$(this),$parent:$(this).find("rect"),"modal-position":"body",placement:"left",boundingSize:o.drawing}),$clusterPopover.modalPopover("show"),$clusterPopover.on("mousedown mousewheel",function(t){log.info("popover click"),t.stopPropagation()})})},l=function(t){t.select("rect.border").empty()&&t.append("rect").classed("border",!0),t.select("rect.border").attr({width:o.layout.width,height:o.layout.height})},s=function(t){var e=new Set;t.map(function(t){e.add(t.trait)});var n=Array.from(e).sort();return n};return e.onAnnotationSelectFunction=function(t){return arguments.length?(o.onAnnotationSelectFunction=t,e):o.onAnnotationSelectFunction},e.layout=function(t){return arguments.length?(o.layout=t,e):o.layout},e.drawing=function(t){return arguments.length?(o.drawing=t,e):o.drawing},e.longestChromosome=function(t){return arguments.length?(o.longestChromosome=t,e):o.longestChromosome},e.chromosomeWidth=function(t){return arguments.length?(o.chromosomeWidth=t,e):o.chromosomeWidth},e.annotationLabelSize=function(t){return arguments.length?(o.annotationLabelSize=t,e):o.annotationLabelSize},e.annotationMarkerSize=function(t){return arguments.length?(o.annotationMarkerSize=t,e):o.annotationMarkerSize},e.showAnnotationLabels=function(t){return arguments.length?(o.showAnnotationLabels=t,e):o.showAnnotationLabels},e.maxSnpPValue=function(t){return arguments.length?(o.maxSnpPValue=t,e):o.maxSnpPValue},e.infoBoxManager=function(t){
return arguments.length?(o.infoBoxManager=t,e):o.infoBoxManager},e.scale=function(t){return arguments.length?(o.scale=t,e):o.scale},e};var GENEMAP=GENEMAP||{};GENEMAP.QTLAnnotationLayout=function(t){var e={scale:1,longestChromosome:1e3,showAllQTLs:!0,showSelectedQTLs:!0,showAutoQTLLabels:!0,showSelectedQTLLabels:!0,annotationLabelSize:5},n=_.merge({},e,t),o=GENEMAP.QtlPositioner(),a=function(){return d3.scale.linear().range([0,n.layout.height]).domain([0,n.longestChromosome])},i=function(t){return t.map(function(t){var e=h(t),n=e.reduce(function(t,e){return Math.min(t,e.start)},1/0),o=e.reduce(function(t,e){return Math.max(t,e.end)},0),a=e.reduce(function(t,e){return t+(t?"|":"")+e.start+"-"+e.end},""),i=(n+o)/2;if(1==e.length){var r=e[0];r.type="qtl",r.index=t.index,r.parentIndex=t.parentIndex}else var r={cluster:t,index:t.index,parentIndex:t.parentIndex,qtlList:e,color:e[0].color,count:e.length,start:n,end:o,midpoint:i,chromosome:e[0].chromosome,type:"qtllist",id:a};return r})},r=function(t){var e=[];if(n.showAllQTLs){t.layout.qtlDisplayClusters=t.layout.qtlClusters.slice();for(var a=t.layout.qtlDisplayClusters,r=Math.ceil(Math.floor(n.scale-.1)/2);r--;)a=d(a);for(var l=a.length;;){e=i(a),e=o.sortQTLAnnotations(e);var s=e.reduce(function(t,e){return Math.max(t,e.position)},0);if(!(s<2))break;if(a=d(a),l==a.length)break;l=a.length}}else if(n.showSelectedQTLs){t.layout.qtlDisplayClusters=t.annotations.qtls.filter(function(t){return t.selected});var a=t.layout.qtlDisplayClusters,e=a.map(function(t){return result=t,result.type="qtl",result})}return e},l=function(t){log.trace("Do label layout");var e=_.groupBy(t,"position");return _.forOwn(e,function(t,e){log.trace("-Col ",e),log.trace("positions ",t.map(function(t){return t.position}));var i=14/n.scale,r=a();t=o.sortQTLLabels(t,r,i);var l=t.reduce(function(t,e){return Math.max(e.labelPosition,t)},0);log.trace("labelPositions ",t.map(function(t){return t.labelPosition})),log.trace("maxLabelPosition",l),t.forEach(function(t){t.labelPosition>1?t.displayLabel=!1:(t.displayLabel=!0,t.labelPosition=t.position+.4)}),log.trace("labelPositions",t.map(function(t){return t.labelPosition}))}),t},s=function(t){log.trace("---START---");var e=r(t);e.forEach(function(t){t.displayLabel=!1});var i=e.filter(function(t){return"qtl"==t.type});if(n.showAutoQTLLabels){e=o.sortQTLAnnotations(e);var s=e.reduce(function(t,e){return Math.max(t,e.position)},0);log.trace("maxPosition",s),i.forEach(function(t){t.label.length>15?t.screenLabel=t.label.substring(0,12)+"...":t.screenLabel=t.label});var c=14/n.scale,u=c>.6*n.layout.chromosomeWidth,d=s>3;d||u?i.forEach(function(t){t.displayLabel=!1}):(l(i),i.forEach(function(t){t.fontSize=c}))}if(n.showSelectedQTLLabels&&!n.showAutoQTLLabels){var h=e.filter(function(t){return t.selected}),c=14/n.scale,p=.3*n.layout.chromosomeWidth;h.forEach(function(t){t.displayLabel=!0,t.screenLabel=t.label,t.fontSize=Math.min(c,2*p)}),h=o.sortQTLAnnotationsWithLabels(h,a(),n.annotationLabelSize),h.forEach(function(t){t.position=t.comboPosition,t.labelPosition=t.comboPosition+.4})}return e},c=function(t,e){if(t.index=e.index,e.index=e.index+1,t.value)t.unit=!0,t.start=t.value.start,t.end=t.value.end;else{var n=t.left,o=t.right;n.parentIndex=t.index,o.parentIndex=t.index,c(n,e),c(o,e),t.unit=n.unit&&o.unit&&n.start==o.start&&n.end==o.end,t.start=Math.min(t.left.start,t.right.start),t.end=Math.max(t.left.end,t.right.end)}},u=function(t){var e=hcluster.hcluster(t.annotations.qtls,function(t,e){if(t.end==e.end&&t.start==e.start)return 0;var n=Math.min(t.end,e.end)-Math.max(t.start,e.start),o=t.end-t.start,a=e.end-e.start,i=n,r=Math.abs(o-a);return Math.max(.1,r-i)},"single",null),n={index:0};return e.forEach(function(t){c(t,n)}),e},d=function(t){var e=[];return t.forEach(function(t){if(t.value||t.unit)e.push(t);else{var n=t.left,o=t.right;e.push(n),e.push(o)}}),e},h=function(t){return 1==t.size?[t.value]:h(t.left).concat(h(t.right))};return my={},my.layoutChromosome=function(t){t.layout.qtlNodes=s(t)||t.layout.qtlNodes},my.computeChromosomeClusters=function(t){t.layout.qtlClusters=u(t)},my};var GENEMAP=GENEMAP||{};GENEMAP.QtlPositioner=function(){var t={};return t.positionAnnotations=function(t,e,n,o,a,i){for(var r=o,l=i,s=a,c=function(t,e){return r(t)<l(e)&&r(e)<l(t)},u=t.sort(function(t,e){return s(t)-s(e)}),d=[],h=0;h<u.length;h++){for(var p=t[h],f=[],m=0;m<d.length;m++){var g=u[d[m]];c(p,g)||f.push(d[m])}var v=_.difference(d,f),y=v.map(function(t){return e(u[t])}),b=0;for(b=1;b<y.length+1&&y.indexOf(b)!==-1;b++);n(p,b),d.push(h)}return u},t.sortQTLAnnotations=function(e){return t.positionAnnotations(e,function(t){return t.position},function(t,e){t.position=e},function(t){return t.start},function(t){return t.midpoint},function(t){return t.end})},t.sortQTLLabels=function(e,n,o){var a=e,i=.6,r=i*o;return t.positionAnnotations(a,function(t){return t.labelPosition},function(t,e){t.labelPosition=e},function(t){return n(t.midpoint)-r*t.screenLabel.length/2},function(t){return t.midpoint},function(t){return n(t.midpoint)+r*t.screenLabel.length/2})},t.sortQTLAnnotationsWithLabels=function(e,n,o){var a=e;return t.positionAnnotations(a,function(t){return t.comboPosition},function(t,e){t.comboPosition=e},function(t){return Math.min(n(t.midpoint)-t.label.length*o/2,t.start)},function(t){return t.midpoint},function(t){return Math.max(n(t.midpoint)+t.label.length*o/2,t.end)})},t};var GENEMAP=GENEMAP||{};GENEMAP.XmlDataReader=function(){var t=function(t){var e=new Array(8-t.length+1).join("0");return color="#"+e+t.substring(2,t.length),"#00FF00"==color&&(color="#208000"),color},e=function(e){return e.chromosomes.forEach(function(e){e.annotations={allGenes:[],genes:[],qtls:[],snps:[]},e.bands.forEach(function(e){e.color=t(e.color)})}),e},n=function(n){var o=e(n[0]),a=n[1];a.features.forEach(function(e){e.color=t(e.color)});a.features.filter(function(t){return"gene"===t.type.toLowerCase()}).forEach(function(t,e){t.globalIndex=e});return o.chromosomes.forEach(function(t){var e=a.features.filter(function(e){return e.chromosome===t.number}),n=e.filter(function(t){return"gene"===t.type.toLowerCase()}),o=e.filter(function(t){return"qtl"===t.type.toLowerCase()}),i=e.filter(function(t){return"snp"===t.type.toLowerCase()}),r=i.reduce(function(t,e){return Math.min(t,e.pvalue)},1);i.forEach(function(e,n){e.id=t.number+"_"+n,e.importance=Math.log(e.pvalue)/Math.log(r)}),o.forEach(function(e,n){e.id=t.number+"_"+n,e.selected=!1});var l=(o.reduce(function(t,e){return Math.max(t,e.score)},0),.9),s=3.5,c=function(t){return l-.5+1/(1+Math.pow(t,s))};n.forEach(function(t,e){t.visible=!1,t.hidden=!1,t.displayed=!1,t.importance=c(e)});var u=n.slice(0,100);t.annotations={genes:u,allGenes:n,qtls:o,snps:i}}),o};return{readXMLData:function(t,o){var a=GENEMAP.BasemapXmlReader(),i=a.readBasemapXML(t);if(o){var r=GENEMAP.AnnotationXMLReader(),l=r.readAnnotationXML(o),s=Promise.all([i,l]).then(n,function(t){return log.error("error while reading XML files: "+t),i.then(e)});return s}return i.then(e)}}};